{% extends 'base.html' %}
{% block title %}Conversation - Campus Connect{% endblock %}
{% block content %}
<div class="max-w-4xl mx-auto">
  <div class="bg-white rounded-xl shadow-lg p-4 mb-4 flex flex-col sm:flex-row items-start sm:items-center justify-between gap-3">
    <div>
      <h1 class="text-xl md:text-2xl font-bold text-university-blue">Conversation</h1>
      <p class="text-sm text-gray-500">Participants:
        {% for u in conversation.participants.all %}
          {% if u != user %}
            @{{ u.username }}{% if not forloop.last %}, {% endif %}
          {% endif %}
        {% endfor %}
      </p>
    </div>
    <a href="{% url 'chat:inbox' %}" class="text-university-blue hover:text-university-blue-light text-sm">Back to Inbox</a>
  </div>

  <div id="messages" class="bg-white rounded-xl shadow-inner p-3 md:p-4 h-[50vh] sm:h-[60vh] overflow-y-auto">
    {% for m in messages %}
      <div class="mb-3 flex {% if m.sender == user %}justify-end{% else %}justify-start{% endif %}">
        <div class="max-w-[85%] sm:max-w-[75%] px-3 py-2 md:px-4 md:py-2 rounded-2xl {% if m.sender == user %}bg-university-blue text-white rounded-br-none{% else %}bg-gray-100 text-gray-800 rounded-bl-none{% endif %}">
          <p class="text-sm">{{ m.content|linebreaksbr }}</p>
          <p class="text-[10px] opacity-70 mt-1">{{ m.sender.username }} • {{ m.created_at|time:"H:i" }}</p>
        </div>
      </div>
    {% endfor %}
  </div>

  <form id="chat-form" class="mt-4 flex">
    <input id="message-input" type="text" placeholder="Type your message..." class="flex-1 px-3 py-2 md:px-4 md:py-3 border border-gray-300 rounded-l-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm md:text-base" />
    <button type="submit" class="px-4 md:px-5 bg-university-blue text-white rounded-r-lg hover:bg-university-blue-light text-sm md:text-base">Send</button>
  </form>
</div>

<script>
  const conversationId = parseInt('{{ conversation.id }}', 10);
  const protocol = window.location.protocol === 'https:' ? 'wss' : 'ws';
  const chatSocket = new WebSocket(`${protocol}://${window.location.host}/ws/chat/${conversationId}/`);

  const messagesDiv = document.getElementById('messages');
  const form = document.getElementById('chat-form');
  const input = document.getElementById('message-input');

  chatSocket.onmessage = function(e) {
    const data = JSON.parse(e.data);
    const isSelf = String(data.sender_id) === '{{ user.id }}';
    const wrapper = document.createElement('div');
    wrapper.className = `mb-3 flex ${isSelf ? 'justify-end' : 'justify-start'}`;
    wrapper.innerHTML = `
      <div class="max-w-[85%] sm:max-w-[75%] px-3 py-2 md:px-4 md:py-2 rounded-2xl ${isSelf ? 'bg-university-blue text-white rounded-br-none' : 'bg-gray-100 text-gray-800 rounded-bl-none'}">
        <p class="text-sm"></p>
        <p class="text-[10px] opacity-70 mt-1">${data.sender} • now</p>
      </div>
    `;
    wrapper.querySelector('p.text-sm').innerText = data.message;
    messagesDiv.appendChild(wrapper);
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
  };

  form.addEventListener('submit', function(e) {
    e.preventDefault();
    const msg = input.value.trim();
    if (!msg) return;
    chatSocket.send(JSON.stringify({ 'message': msg }));
    input.value = '';
  });
</script>
{% endblock %}